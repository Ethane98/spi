include ../../../make.config
include ../../../make.flag.tmpl

GCC        = gcc
GXX        = g++
RM         = rm -f
TESTCASE_DIR = ../TestCases

# Test driver
TEST_DRIVER           = test
DRIVER_SRCS          += $(wildcard ../*.C)
DRIVER_OBJS           = $(notdir $(DRIVER_SRCS:%.C=%.o))
DRIVER_LDFLAGS        = -ldl
DRIVER_FLAGS          = -g

# Agent
AGENT_SRCS           += $(wildcard ../TestCases/*agent.C)
AGENT_OBJS            = $(notdir $(AGENT_SRCS:%.C=%.o))
AGENT_SO              = $(notdir $(AGENT_SRCS:%.C=%.so))

AG_FLAGS             += -g
AG_LDFLAGS           += -L$(SP_DIR)/$(PLATFORM)
AG_LDFLAGS           += -lagent

# Mutatee
MUTATEE_SRCS         += $(wildcard ../TestCases/*mutatee.c)
MUTATEE_OBJS          = $(notdir $(MUTATEE_SRCS:%.c=%.o))
MUTATEE_EXE           = $(notdir $(MUTATEE_SRCS:%.c=%))
MUTATEE_LDFLAGS       = -ldl
MUTATEE_IFLAGS        =
MUTATEE_FLAGS         = -fPIC -O0

# Rules
#.PHONY: all
all: MUTATEE AGENT DRIVER COPYIJ
	@echo ""
	@echo "====================="
	@echo " Usage: sh run.sh "
	@echo "====================="

AG_DEP  = .AG_DEPENDS
$(shell if test -f $(AG_DEP); then true; else \
$(GXX) -MM $(AG_IFLAGS) $(AG_FLAGS) $(AGENT_SRCS) > $(AG_DEP);\
fi);\
include $(AG_DEP)

AGENT: $(AGENT_SO)
	@echo "* All agents are done"
$(AGENT_OBJS): %.o : $(TESTCASE_DIR)/%.C
	@echo "Compiling $@"
	@$(GXX) -o $@ $(TESTCASE_DIR)/$*.C $(AG_IFLAGS) $(AG_FLAGS) -c
$(AGENT_SO): %.so : $(AGENT_OBJS)
	@echo "Linking $@"
	@$(GXX) -o $@ $*.o $(AG_LDFLAGS)

MUTATEE_DEP  = .MUTATEE_DEPENDS
$(shell if test -f $(MUTATEE_DEP); then true; else \
$(GXX) -MM $(MUTATEE_IFLAGS) $(MUTATEE_FLAGS) $(MUTATEE_SRCS) > $(MUTATEE_DEP);\
fi);\
include $(MUTATEE_DEP)

MUTATEE: $(MUTATEE_EXE)
	@echo "* All mutatees are done"
$(MUTATEE_OBJS): %.o : $(TESTCASE_DIR)/%.c
	@echo "Compiling $@"
	@$(GCC) -o $@ $(TESTCASE_DIR)/$*.c $(MUTATEE_IFLAGS) $(MUTATEE_FLAGS) -c
$(MUTATEE_EXE): % : $(MUTATEE_OBJS)
	@echo "Linking $@"
	@$(GCC) -o $@ $*.o $(MUTATEE_LDFLAGS)

DRIVER_DEP  = .DRIVER_DEPENDS
$(shell if test -f $(DRIVER_DEP); then true; else \
$(GXX) -MM $(DRIVER_IFLAGS) $(DRIVER_FLAGS) $(DRIVER_SRCS) > $(DRIVER_DEP);\
fi);\
include $(DRIVER_DEP)

DRIVER: $(TEST_DRIVER)
	@echo "* Test driver is done"
$(DRIVER_OBJS): %.o : $(DRIVER_SRC)
	@echo "Compiling $@"
	@$(GXX) -o $@ $(DRIVER_SRCS) $(DRIVER_IFLAGS) $(DRIVER_FLAGS) -c
$(TEST_DRIVER): $(DRIVER_OBJS)
	@echo "Linking $@"
	@$(GXX) -o $@ $(DRIVER_OBJS) $(DRIVER_LDFLAGS)
#	@$(GXX) -o $@ $(DRIVER_OBJS) $(DRIVER_LDFLAGS)

COPYIJ:
	@echo "Copying Injector and libijagent.so..."
	@cp $(SP_DIR)/$(PLATFORM)/Injector $(SP_DIR)/$(PLATFORM)/libijagent.so $(SP_DIR)/$(PLATFORM)/libagent.so ./

# Clean up
clean:
	@rm -f *.so *.o $(TEST_DRIVER) core* Injector libijagent.so $(MUTATEE_EXE) $(MUTATEE_DEP) $(DRIVER_DEP) $(AG_DEP)

# Debug Makefile
d:
	@echo "AGENT_SRCS    =$(AGENT_SRCS)"
	@echo "MUTATEE_SRCS  =$(MUTATEE_SRCS)"
	@echo "AGENT_SO      =$(AGENT_SO)"
	@echo "MUTATEE_SO    =$(MUTATEE_SO)"
