include ../../../make.config
include ../../../make.flag.tmpl

GCC        = gcc
GXX        = g++
RM         = rm -f
TESTCASE_DIR = ../TestCases

# Test driver
TEST_DRIVER           = test
DRIVER_SRCS          += $(wildcard ../*.C)
DRIVER_OBJS           = $(notdir $(DRIVER_SRCS:%.C=%.o))
DRIVER_LDFLAGS        = -ldl
DRIVER_FLAGS          = -g

# Agent
AGENT_SRCS           += $(wildcard ../TestCases/*agent.C)
AGENT_OBJS            = $(notdir $(AGENT_SRCS:%.C=%.o))
AGENT_SO              = $(notdir $(AGENT_SRCS:%.C=%.so))

AG_FLAGS             += -g
AG_LDFLAGS           += -L$(SP_DIR)/$(PLATFORM)
AG_LDFLAGS           += -lagent

# Mutatee
MUTATEE_SRCS         += $(wildcard ../TestCases/*mutatee.c)
MUTATEE_OBJS          = $(notdir $(MUTATEE_SRCS:%.c=%.o))
MUTATEE_SO            = $(notdir $(MUTATEE_SRCS:%.c=%.so))
MUTATEE_LDFLAGS       = -shared
MUTATEE_IFLAGS        =
MUTATEE_FLAGS         = -fPIC

# Rules
#.PHONY: all
all: MUTATEE AGENT DRIVER COPYIJ
	@echo ""
	@echo "====================="
	@echo " Usage: sh run.sh "
	@echo "====================="

AG_DEP  = .AG_DEPENDS
AG_DEPS:
	@echo "Makeing dependency Agents"
	@$(GXX) -MM $(AG_IFLAGS) $(AG_FLAGS) $(AGENT_SRCS) > $(AG_DEP)
include $(AG_DEP)

AGENT: $(AGENT_SO)
	@echo "* All agents are done"
$(AGENT_OBJS): %.o : $(AGENT_SRCS)
	@echo "Compiling $@"
	@$(GXX) -o $@ $(TESTCASE_DIR)/$*.C $(AG_IFLAGS) $(AG_FLAGS) -c
$(AGENT_SO): %.so : $(AGENT_OBJS)
	@echo "Linking $@"
	@$(GXX) -o $@ $*.o $(AG_LDFLAGS)

MUTATEE_DEP  = .MUTATEE_DEPENDS
MUTATEE_DEPS:
	@echo "Makeing dependency for Mutatees"
	@$(GXX) -MM $(MUTATEE_IFLAGS) $(MUTATEE_FLAGS) $(MUTATEE_SRCS) > $(MUTATEE_DEP)
include $(MUTATEE_DEP)

MUTATEE: $(MUTATEE_SO)
	@echo "* All mutatees are done"
$(MUTATEE_OBJS): %.o : $(MUTATEE_SRCS)
	@echo "Compiling $@"
	@$(GCC) -o $@ $(TESTCASE_DIR)/$*.c $(MUTATEE_IFLAGS) $(MUTATEE_FLAGS) -c
$(MUTATEE_SO): %.so : $(MUTATEE_OBJS)
	@echo "Linking $@"
	@$(GCC) -o $@ $*.o $(MUTATEE_LDFLAGS)

DRIVER_DEP  = .DRIVER_DEPENDS
DRIVER_DEPS:
	@echo "Makeing dependency for Test driver"
	@$(GXX) -MM $(DRIVER_IFLAGS) $(DRIVER_FLAGS) $(DRIVER_SRCS) > $(DRIVER_DEP)
include $(DRIVER_DEP)

DRIVER: $(TEST_DRIVER)
	@echo "* Test driver is done"
$(DRIVER_OBJS): %.o : $(DRIVER_SRCS)
	@echo "Compiling $@"
	@$(GXX) -o $@ $(DRIVER_SRCS) $(DRIVER_IFLAGS) $(DRIVER_FLAGS) -c
$(TEST_DRIVER): $(DRIVER_OBJS)
	@echo "Linking $@"
	@$(GXX) -o $@ $(DRIVER_OBJS) $(DRIVER_LDFLAGS) -L$(DYNINST_DIR)/stackwalk/$(PLATFORM) -lstackwalk
#	@$(GXX) -o $@ $(DRIVER_OBJS) $(DRIVER_LDFLAGS)

COPYIJ:
	@echo "Copying Injector and libijagent.so..."
	cp $(SP_DIR)/$(PLATFORM)/Injector $(SP_DIR)/$(PLATFORM)/libijagent.so ./

# Clean up
clean:
	@rm -f *.so *.o $(TEST_DRIVER) core* Injector libijagent.so
	@make AG_DEPS
	@make MUTATEE_DEPS
	@make DRIVER_DEPS

# Debug Makefile
d:
	@echo "AGENT_SRCS    =$(AGENT_SRCS)"
	@echo "MUTATEE_SRCS  =$(MUTATEE_SRCS)"
	@echo "AGENT_SO      =$(AGENT_SO)"
	@echo "MUTATEE_SO    =$(MUTATEE_SO)"
